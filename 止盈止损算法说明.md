# 止盈止损算法说明文档

## 1. 算法概述

### 1.1 目的和用途

止盈止损算法用于计算在给定止盈和止损目标下，股票信号的实际触发情况。该算法帮助投资者：

- 评估不同止盈止损策略的效果
- 分析历史信号的收益表现
- 优化交易策略参数
- 计算收益矩阵，找到最佳止盈止损组合

### 1.2 基本概念

- **买入价（buyPrice）**：信号产生时的股票价格，通常为收盘价
- **止盈价（profitPrice）**：目标盈利价格，计算公式：`买入价 × (1 + 止盈百分比 / 100)`
- **止损价（lossPrice）**：目标止损价格，计算公式：`买入价 × (1 + 止损百分比 / 100)`
- **触发**：股票价格触及止盈价或止损价
- **触发天数**：从信号产生到触发止盈/止损的天数

## 2. 算法逻辑

### 2.1 数据来源

算法使用两种数据源：

1. **每日价格数据（推荐）**：包含每日的开盘价、最高价、最低价、收盘价
   - 数据来源：`stock_signal_daily_prices` 表
   - 优势：可以准确判断触发顺序和时机

2. **极值数据（向后兼容）**：只包含最高价、最低价及其日期
   - 数据来源：`stock_signals` 表
   - 限制：无法准确判断同一天都触及时的先后顺序

### 2.2 触发条件

#### 2.2.1 止盈触发条件

- **盘中策略**（当前实现）：当日最高价 >= 止盈价
- **收盘价策略**：当日收盘价 >= 止盈价（未来可支持）

#### 2.2.2 止损触发条件

- **盘中策略**（当前实现）：当日最低价 <= 止损价
- **收盘价策略**：当日收盘价 <= 止损价（未来可支持）

### 2.3 判断流程

#### 2.3.1 使用每日价格数据的流程

```
1. 按时间顺序遍历每日价格数据（从信号产生当天开始）

2. 对每一天：
   a. 检查最高价是否 >= 止盈价
   b. 检查最低价是否 <= 止损价
   
3. 如果只触及止盈：
   → 返回止盈结果，记录触发天数
   
4. 如果只触及止损：
   → 返回止损结果，记录触发天数
   
5. 如果同一天都触及：
   a. 检查开盘价是否直接触发
      - 开盘价 <= 止损价 → 开盘触发止损
      - 开盘价 >= 止盈价 → 开盘触发止盈
   b. 如果开盘价在中间（止损价 < 开盘价 < 止盈价）：
      - 计算相对距离比例
      - 距离更近的先触发
      
6. 如果遍历完所有天数都没有触及：
   → 返回 null（未触发）
```

#### 2.3.2 同一天都触及的判断逻辑（优化后）

**场景**：某一天的最高价 >= 止盈价，且最低价 <= 止损价

**判断步骤**：

1. **优先检查开盘价**
   ```javascript
   if (开盘价 <= 止损价) {
       return 止损; // 开盘就触发止损
   }
   if (开盘价 >= 止盈价) {
       return 止盈; // 开盘就触发止盈
   }
   ```

2. **开盘价在中间，使用相对距离判断**
   ```javascript
   // 计算相对距离比例
   止盈幅度 = 止盈价 - 买入价
   止损幅度 = 买入价 - 止损价
   
   距离止盈的比例 = (止盈价 - 开盘价) / 止盈幅度
   距离止损的比例 = (开盘价 - 止损价) / 止损幅度
   
   // 距离比例更小的先触发
   if (距离止盈的比例 <= 距离止损的比例) {
       return 止盈;
   } else {
       return 止损;
   }
   ```

**为什么使用相对距离？**

- 绝对距离可能不公平：如果止盈10%，止损5%，绝对距离比较不公平
- 相对距离更合理：考虑各自的幅度范围，更公平地比较哪个更容易触发

### 2.4 特殊情况处理

#### 2.4.1 开盘价直接触发

**情况1：开盘价 <= 止损价**
- 处理：立即触发止损
- 理由：开盘就触及止损价，即使盘中涨到止盈价，也应该先止损

**情况2：开盘价 >= 止盈价**
- 处理：立即触发止盈
- 理由：开盘就触及止盈价，即使盘中跌到止损价，也应该先止盈

#### 2.4.2 数据缺失

- **没有每日价格数据**：使用旧逻辑（比较最高价和最低价的天数）
- **缺少开盘价**：使用买入价作为开盘价的替代
- **价格数据为空**：跳过该天，继续检查下一天

#### 2.4.3 边界情况

- **止盈价 = 止损价**：理论上不可能，但如果发生，优先触发止损（保守策略）
- **开盘价 = 止盈价或止损价**：视为直接触发
- **最高价 = 止盈价或最低价 = 止损价**：视为触及

## 3. 场景示例

### 场景1：开盘价直接触发止损

**数据**：
- 买入价：100元
- 止盈：110元（+10%）
- 止损：95元（-5%）
- 第3天：开盘价94元，最高价108元，最低价93元

**判断过程**：
1. 开盘价94元 <= 止损价95元 ✓
2. 开盘就触发止损

**结果**：`{ profit: -5, days: 3, type: "loss" }`

### 场景2：开盘价直接触发止盈

**数据**：
- 买入价：100元
- 止盈：110元（+10%）
- 止损：95元（-5%）
- 第5天：开盘价112元，最高价115元，最低价108元

**判断过程**：
1. 开盘价112元 >= 止盈价110元 ✓
2. 开盘就触发止盈

**结果**：`{ profit: 10, days: 5, type: "profit" }`

### 场景3：同一天都触及，开盘价在中间

**数据**：
- 买入价：100元
- 止盈：110元（+10%）
- 止损：95元（-5%）
- 第7天：开盘价102元，最高价112元，最低价94元

**判断过程**：
1. 开盘价102元在止损价95元和止盈价110元之间
2. 最高价112元 >= 止盈价110元 ✓
3. 最低价94元 <= 止损价95元 ✓
4. 计算相对距离：
   - 止盈幅度 = 110 - 100 = 10元
   - 止损幅度 = 100 - 95 = 5元
   - 距离止盈的比例 = (110 - 102) / 10 = 0.8
   - 距离止损的比例 = (102 - 95) / 5 = 1.4
5. 0.8 < 1.4，更接近止盈价

**结果**：`{ profit: 10, days: 7, type: "profit" }`

### 场景4：多天触发，先触发止损

**数据**：
- 买入价：100元
- 止盈：110元（+10%）
- 止损：95元（-5%）
- 第3天：开盘价98元，最高价105元，最低价94元（触及止损）
- 第10天：最高价112元（触及止盈）

**判断过程**：
1. 第3天：最低价94元 <= 止损价95元，触发止损
2. 返回结果，不再检查后续天数

**结果**：`{ profit: -5, days: 3, type: "loss" }`

### 场景5：多天触发，先触发止盈

**数据**：
- 买入价：100元
- 止盈：110元（+10%）
- 止损：95元（-5%）
- 第2天：最高价111元（触及止盈）
- 第5天：最低价94元（触及止损）

**判断过程**：
1. 第2天：最高价111元 >= 止盈价110元，触发止盈
2. 返回结果，不再检查后续天数

**结果**：`{ profit: 10, days: 2, type: "profit" }`

### 场景6：未触发

**数据**：
- 买入价：100元
- 止盈：110元（+10%）
- 止损：95元（-5%）
- 30天内最高价108元，最低价96元

**判断过程**：
1. 最高价108元 < 止盈价110元
2. 最低价96元 > 止损价95元
3. 都没有触及

**结果**：`null`（未触发）

## 4. 优化历史

### 4.1 初始版本的问题

**问题1：数据不完整**
- 只存储最高价和最低价，没有每日价格数据
- 无法准确判断触发顺序

**问题2：判断逻辑错误**
- 只比较最高价和最低价的天数
- 如果先跌到止损价，后涨到止盈价，可能误判为先触发止盈

**问题3：同一天都触及的处理不合理**
- 使用绝对距离比较，不公平
- 没有考虑开盘价直接触发的情况

### 4.2 优化后的改进

**改进1：存储每日价格数据**
- 创建 `stock_signal_daily_prices` 表
- 存储每日的开盘、最高、最低、收盘价
- 可以准确判断触发顺序

**改进2：优化判断逻辑**
- 按时间顺序遍历每日价格
- 准确判断哪个先触发

**改进3：改进同一天都触及的处理**
- 优先检查开盘价是否直接触发
- 使用相对距离比例判断，更公平合理

### 4.3 未来可能的改进

**改进方向1：支持多种交易策略**
- 收盘价策略：只在收盘时检查
- 盘中策略：盘中触及即触发（当前实现）
- 开盘价策略：只在开盘时检查

**改进方向2：更精确的盘中触发判断**
- 如果有分钟级数据，可以更精确判断触发时间
- 考虑价格走势（先涨后跌 vs 先跌后涨）

**改进方向3：考虑滑点和手续费**
- 实际交易中，触发价格可能略有偏差
- 考虑交易手续费对收益的影响

**改进方向4：支持部分止盈/止损**
- 部分仓位止盈，部分仓位继续持有
- 更复杂的策略回测

## 5. 使用说明

### 5.1 如何设置止盈止损

在收益矩阵界面：

1. **设置筛选条件**：
   - 日期范围
   - 股票代码
   - 价格范围
   - 其他筛选条件

2. **查看收益矩阵**：
   - 横列：止盈百分比（2% 到 30%，步长2%）
   - 纵列：止损百分比（-2% 到 -30%，步长2%）
   - 单元格：显示平均收益和触发数量

3. **理解计算结果**：
   - 正数（绿色）：平均盈利
   - 负数（红色）：平均亏损
   - 括号内数字：止盈数量（红色），止损数量（绿色）
   - 紫色背景：达到置信度阈值（默认80%）

### 5.2 如何理解计算结果

**收益矩阵单元格示例**：
```
+5.23% (8, 2)
```

含义：
- `+5.23%`：平均收益为5.23%
- `(8, 2)`：8只股票触发止盈，2只股票触发止损
- 总共10只股票触发，触发率 = 10 / 总股票数

**置信度标记**：
- 紫色背景：达到目标的股票占比 >= 80%
- 表示该策略组合有较高的可信度

### 5.3 注意事项

1. **数据完整性**
   - 确保有每日价格数据，否则使用旧逻辑可能不够准确
   - 运行 `backfill_daily_prices.py` 补充历史数据

2. **策略假设**
   - 当前实现假设"盘中触及即触发"
   - 实际交易中，可能无法在触及价格立即成交
   - 结果仅供参考，不构成投资建议

3. **计算范围**
   - 默认计算信号产生后30天内的触发情况
   - 如果30天内未触发，返回null

4. **性能考虑**
   - 大量数据计算可能需要一些时间
   - 建议使用筛选条件缩小计算范围

5. **数据质量**
   - 确保价格数据准确
   - 注意停牌、复牌等特殊情况

## 6. 算法实现细节

### 6.1 核心函数

**函数名**：`calculateProfitForStock(rec, profitTarget, stopLoss)`

**参数**：
- `rec`：股票记录对象，包含买入价和每日价格数据
- `profitTarget`：止盈百分比（正数，如10表示10%）
- `stopLoss`：止损百分比（负数，如-5表示-5%）

**返回值**：
- `null`：未触发
- `{ profit: number, days: number, type: "profit" | "loss" }`：触发结果

### 6.2 代码位置

- **文件**：`Spiders/web/static/js/calendar.js`
- **行号**：265-341行

### 6.3 调用位置

- **收益矩阵计算**：`updateCalc()` 函数
- **行号**：436-540行

## 7. 总结

止盈止损算法经过优化后，能够：

1. ✅ 准确判断触发顺序（使用每日价格数据）
2. ✅ 合理处理同一天都触及的情况（优先开盘价，使用相对距离）
3. ✅ 支持向后兼容（没有每日价格数据时使用旧逻辑）
4. ✅ 提供清晰的收益矩阵分析

该算法为投资者提供了有价值的策略分析工具，帮助优化交易参数，提高投资决策的科学性。
