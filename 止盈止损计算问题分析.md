# 止盈止损计算问题分析

## 当前问题

### 1. 数据存储不完整
- **当前存储**：只存储了 `highest_price`、`lowest_price` 及其日期和天数
- **缺失数据**：没有存储信号产生后每天的股票价格

### 2. 计算逻辑错误

当前代码逻辑（`calendar.js` 第265-295行）：
```javascript
function calculateProfitForStock(rec, profitTarget, stopLoss) {
    const highDays = rec.highDays || 999999;
    const lowDays = rec.lowDays || 999999;
    
    // 比较哪个天数更小，认为先触发
    if (canReachProfit && highDays < firstHitDays) {
        firstHit = "profit";
        firstHitDays = highDays;
    }
    if (canReachLoss && lowDays < firstHitDays) {
        firstHit = "loss";
        firstHitDays = lowDays;
    }
}
```

**问题场景**：
- 假设买入价：100元
- 止盈目标：110元（+10%）
- 止损目标：95元（-5%）

**场景1：先止损后止盈**
- 第3天：最低价 94元（触及止损）
- 第10天：最高价 112元（触及止盈）
- `highDays=10, lowDays=3`
- **当前逻辑**：比较 `highDays(10) < firstHitDays(999999)` → 先触发止盈 ❌
- **正确逻辑**：应该先触发止损（第3天）✅

**场景2：价格波动**
- 第2天：最高价 111元（触及止盈）
- 第5天：最低价 94元（触及止损）
- `highDays=2, lowDays=5`
- **当前逻辑**：先触发止盈（第2天）✅
- **但问题**：如果第2天最高价是111元，但收盘价是108元，实际可能没有触及止盈

### 3. 无法准确判断触发时机

当前方法无法准确判断：
1. **哪个先触发**：只比较最高价和最低价的天数，无法反映实际触发顺序
2. **实际触发价格**：如果止盈目标是110元，但最高价是112元，实际触发价格应该是110元，而不是112元
3. **日内波动**：如果某天最高价触及止盈，但收盘价回落，实际是否触发取决于交易策略（是否在盘中卖出）

## 解决方案

### 方案1：存储每日价格数据（推荐）

**新增数据库表**：`stock_signal_daily_prices`

```sql
CREATE TABLE IF NOT EXISTS stock_signal_daily_prices (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    signal_id INTEGER,  -- 关联 stock_signals.id
    stock_code TEXT,
    date TEXT,          -- 日期
    open REAL,          -- 开盘价
    high REAL,          -- 最高价
    low REAL,           -- 最低价
    close REAL,         -- 收盘价
    days_from_signal INTEGER,  -- 距离信号产生的天数（0表示当天）
    created_at TEXT,
    FOREIGN KEY (signal_id) REFERENCES stock_signals(id),
    UNIQUE(signal_id, date)
)
```

**修改爬虫代码**：
- 在 `stock_kline.py` 的 `update_price_extremes` 方法中，保存每日价格数据

**修改前端计算逻辑**：
- 按时间顺序遍历每日价格
- 检查每天的最高价和最低价是否触及止盈/止损
- 哪个先触及，就按哪个计算

### 方案2：在计算时记录触发信息（简化版）

**修改数据库表**：在 `stock_signals` 表中新增字段
```sql
ALTER TABLE stock_signals ADD COLUMN profit_loss_trigger_date TEXT;  -- 止盈/止损触发日期
ALTER TABLE stock_signals ADD COLUMN profit_loss_trigger_type TEXT;   -- 'profit' 或 'loss'
ALTER TABLE stock_signals ADD COLUMN profit_loss_trigger_price REAL;  -- 触发价格
ALTER TABLE stock_signals ADD COLUMN profit_loss_trigger_days INTEGER; -- 触发天数
```

**修改爬虫代码**：
- 在计算最高价和最低价时，同时计算止盈止损触发信息
- 按时间顺序检查每日价格，记录最先触发的信息

## 推荐实现步骤

1. **创建新表**：`stock_signal_daily_prices`
2. **修改爬虫**：保存每日价格数据
3. **修改前端**：使用每日价格数据计算止盈止损
4. **数据迁移**：对历史数据，可以重新爬取或从现有数据推算

## 注意事项

1. **交易策略**：止盈止损的触发取决于策略：
   - **收盘价策略**：只在收盘时检查是否触发
   - **盘中策略**：盘中触及即触发
   - **当前实现**：建议使用收盘价策略（更保守）

2. **数据量**：每个信号存储30天的数据，如果信号很多，数据量会较大

3. **性能**：前端计算时，需要查询每日价格数据，可能需要优化查询性能
