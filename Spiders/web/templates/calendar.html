<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËÇ°Á•®‰ø°Âè∑Êó∂Èó¥ËΩ¥ËßÜÂõæ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        .header {
            background: #ffffff;
            border-radius: 15px;
            padding: 20px 24px;
            margin-bottom: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-left {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .header-title {
            font-size: 24px;
            color: #333333;
        }
        .header-subtitle {
            font-size: 14px;
            color: #666666;
        }
        .header-actions {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 10px 18px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }
        .btn-secondary {
            background: #f5f5f5;
            color: #666666;
        }
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        .controls {
            background: #ffffff;
            border-radius: 15px;
            padding: 18px 20px;
            margin-bottom: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .controls-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            align-items: end;
            margin-bottom: 16px;
        }
        .controls-row:last-child {
            margin-bottom: 0;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .control-label {
            font-size: 13px;
            color: #666666;
        }
        .control-input {
            padding: 8px 10px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            font-size: 13px;
        }
        .control-input:focus {
            outline: none;
            border-color: #667eea;
        }
        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .slider-wrapper {
            flex: 1;
            position: relative;
        }
        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .slider-value {
            min-width: 60px;
            text-align: center;
            font-size: 13px;
            color: #666;
            font-weight: 500;
        }
        .slider-label-row {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #999;
            margin-top: 2px;
        }
        .toggle-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        .toggle-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
            color: #444444;
        }
        .timeline-wrapper {
            background: #ffffff;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .timeline-container {
            position: relative;
            display: flex;
            height: calc(100vh - 400px);
            min-height: 600px;
        }
        .timeline-axis {
            position: relative;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
        }
        .timeline-content {
            position: relative;
            width: 100%;
            min-height: 100%;
        }
        .time-marker {
            position: absolute;
            left: 0;
            width: 100%;
            border-top: 1px solid #e0e0e0;
            pointer-events: none;
        }
        .time-marker.major {
            border-top-width: 2px;
            border-top-color: #999999;
        }
        .time-label {
            position: absolute;
            left: 8px;
            top: -10px;
            font-size: 11px;
            color: #666666;
            background: #ffffff;
            padding: 2px 6px;
            white-space: nowrap;
        }
        .time-label.major {
            font-weight: 600;
            color: #333333;
            font-size: 12px;
        }
        .stock-line {
            position: absolute;
            width: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.2s;
        }
        .stock-line-high {
            background: rgba(229,57,53,0.6);
        }
        .stock-line-low {
            background: rgba(67,160,71,0.6);
        }
        .stock-point {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid #ffffff;
            cursor: pointer;
            box-shadow: 0 0 4px rgba(0,0,0,0.4);
            transform: translate(-50%, -50%);
            transition: opacity 0.2s, transform 0.2s;
        }
        .stock-point-buy {
            background: #757575;
            border-radius: 2px;
            width: auto;
            height: 8px;
        }
        .stock-point-buy.rect {
            width: 14px;
            height: 8px;
            border-radius: 2px;
            transform: translate(-50%, -50%);
        }
        .stock-point-high {
            background: #e53935;
        }
        .stock-point-low {
            background: #43a047;
        }
        .tooltip {
            position: fixed;
            background: #1e1e1e;
            color: #ffffff;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            max-width: 600px;
            line-height: 1.5;
            max-height: 400px;
            overflow-y: auto;
        }
        .tooltip-stocks {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 8px;
        }
        .tooltip-stock-item {
            padding: 6px;
            background: #2a2a2a;
            border-radius: 4px;
            font-size: 11px;
        }
        .tooltip-stock-code {
            font-weight: 600;
            color: #ffffff;
        }
        .tooltip-stock-name {
            color: #bbbbbb;
            font-size: 10px;
        }
        .tooltip-stock-info {
            margin-top: 4px;
            color: #bbbbbb;
            font-size: 10px;
        }
        .tooltip-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .tooltip-row {
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }
        .tooltip-label {
            color: #bbbbbb;
        }
        .legend {
            margin-top: 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 12px;
            color: #555555;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 4px;
        }
        .legend-high {
            background: #e53935;
        }
        .legend-low {
            background: #43a047;
        }
        .legend-buy {
            background: #757575;
        }
        .legend-buy-color-1 {
            background: #c62828;
        }
        .legend-buy-color-2 {
            background: #2e7d32;
        }
        .legend-buy-color-3 {
            background: #ff6f00;
        }
        .legend-buy-color-4 {
            background: #66bb6a;
        }
        .legend-buy-color-5 {
            background: #e53935;
        }
        .legend-buy-color-6 {
            background: #43a047;
        }
        .buy-point-legend {
            margin-top: 16px;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 8px;
            font-size: 12px;
        }
        .buy-point-legend-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        .buy-point-legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
        }
        .zoom-hint {
            margin-top: 8px;
            font-size: 11px;
            color: #999999;
        }
        .stats-panel {
            background: #ffffff;
            border-radius: 15px;
            padding: 18px 24px;
            margin-bottom: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .stat-label {
            font-size: 13px;
            color: #666666;
        }
        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #333333;
        }
        .stat-value.positive {
            color: #e53935;
        }
        .stat-value.negative {
            color: #43a047;
        }
        .calc-panel {
            background: #ffffff;
            border-radius: 15px;
            padding: 18px 24px;
            margin-bottom: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .calc-title {
            font-size: 16px;
            font-weight: 600;
            color: #333333;
            margin-bottom: 16px;
        }
        .calc-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            align-items: center;
        }
        .calc-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .calc-label {
            font-size: 13px;
            color: #666666;
        }
        .calc-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }
        .calc-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
        .calc-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }
        .calc-value {
            font-size: 14px;
            color: #333333;
            font-weight: 500;
        }
        .calc-result {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e0e0e0;
        }
        .calc-result-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .calc-result-label {
            font-size: 13px;
            color: #666666;
        }
        .calc-result-value {
            font-size: 20px;
            font-weight: 600;
            color: #333333;
        }
        .calc-result-value.positive {
            color: #e53935;
        }
        .calc-result-value.negative {
            color: #43a047;
        }
        .calc-table {
            margin-top: 16px;
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .calc-table th {
            background: #f5f5f5;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            color: #333333;
            border-bottom: 2px solid #e0e0e0;
        }
        .calc-table td {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        .calc-table tr:hover {
            background: #f9f9f9;
        }
        .calc-table .text-right {
            text-align: right;
        }
        .calc-table .text-center {
            text-align: center;
        }
        .calc-table .profit-positive {
            color: #e53935;
            font-weight: 600;
        }
        .calc-table .profit-negative {
            color: #43a047;
            font-weight: 600;
        }
        .calc-summary {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 2px solid #e0e0e0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <div class="header-title">üìÖ ËÇ°Á•®‰ø°Âè∑ÂûÇÁõ¥Êó∂Èó¥ËΩ¥ËßÜÂõæ</div>
                <div class="header-subtitle">ÂûÇÁõ¥Êó∂Èó¥ËΩ¥ÔºåÈº†Ê†áÊªöËΩÆÁº©ÊîæÔºåÁÇπÂáªÈÄâ‰∏≠ËÇ°Á•®</div>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="window.location.href='/list'">ËøîÂõûÂàóË°®ËßÜÂõæ</button>
            </div>
        </div>
        <div class="stats-panel" id="stats-panel">
            <div class="stat-item">
                <div class="stat-label">ÊÄª‰ø°Âè∑Êï∞</div>
                <div class="stat-value" id="stat-total">-</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">ËÇ°Á•®ÊÄªÊï∞</div>
                <div class="stat-value" id="stat-stocks">-</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Âπ≥ÂùáÊàêÂäüÁéá</div>
                <div class="stat-value" id="stat-success">-</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Âπ≥ÂùáÊúÄÈ´òÊ∂®ÂπÖ</div>
                <div class="stat-value positive" id="stat-highest">-</div>
            </div>
        </div>
        <div class="calc-panel">
            <div class="calc-title">üìä Ê≠¢ÁõàÊ≠¢ÊçüÊî∂ÁõäÁü©ÈòµÔºàÊú¨Èáë1‰∏áÂÖÉ/ËÇ°Á•®Ôºâ</div>
            <div class="controls" style="margin-bottom: 16px;">
                <div class="controls-row">
                    <div class="control-group">
                        <div class="control-label">Êó•ÊúüÂå∫Èó¥</div>
                        <select id="filter-date-range" class="control-input" style="width: 100%;">
                            <option value="" selected>ÂÖ®ÈÉ®</option>
                            <option value="7">ÊúÄËøë7Â§©</option>
                            <option value="14">ÊúÄËøë14Â§©</option>
                            <option value="30">ÊúÄËøë‰∏Ä‰∏™Êúà</option>
                            <option value="60">ÊúÄËøë‰∏§‰∏™Êúà</option>
                            <option value="90">ÊúÄËøë‰∏â‰∏™Êúà</option>
                            <option value="180">ÊúÄËøëÂçäÂπ¥</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <div class="control-label">Ë∑üË∏™Â§©Êï∞ËåÉÂõ¥</div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="number" id="filter-days-min" class="control-input" placeholder="ÊúÄÂ∞èÂ§©Êï∞" style="flex: 1;" min="0" value="10">
                            <span>-</span>
                            <input type="number" id="filter-days-max" class="control-input" placeholder="ÊúÄÂ§ßÂ§©Êï∞" style="flex: 1;" min="0">
                        </div>
                    </div>
                    <div class="control-group">
                        <div class="control-label">ÁΩÆ‰ø°ÁôæÂàÜÊØî</div>
                        <input type="number" id="filter-confidence" class="control-input" placeholder="ÊúÄÂ∞èÁΩÆ‰ø°Â∫¶%" style="width: 100%;" min="0" max="100" step="0.1" value="80">
                        <span style="font-size: 11px; color: #666; margin-top: 2px;">ÔºàËææÂà∞Ê≠¢Áõà/Ê≠¢ÊçüÁöÑËÇ°Á•®Âç†ÊØîÔºâ</span>
                    </div>
                </div>
                <div class="controls-row">
                    <div class="control-group">
                        <div class="control-label">‰π∞ÂÖ•‰ª∑Ê†ºËåÉÂõ¥</div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="number" id="filter-price-min" class="control-input" placeholder="ÊúÄ‰Ωé‰ª∑" style="flex: 1;" min="0" step="0.01">
                            <span>-</span>
                            <input type="number" id="filter-price-max" class="control-input" placeholder="ÊúÄÈ´ò‰ª∑" style="flex: 1;" min="0" step="0.01">
                        </div>
                    </div>
                    <div class="control-group">
                        <div class="control-label">ÊúÄÈ´òÊ∂®ÂπÖËåÉÂõ¥</div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="number" id="filter-high-change-min" class="control-input" placeholder="ÊúÄÂ∞èÊ∂®ÂπÖ%" style="flex: 1;" step="0.01">
                            <span>-</span>
                            <input type="number" id="filter-high-change-max" class="control-input" placeholder="ÊúÄÂ§ßÊ∂®ÂπÖ%" style="flex: 1;" step="0.01">
                        </div>
                    </div>
                </div>
                <div class="controls-row">
                    <div class="control-group">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                            <input type="checkbox" id="filter-enable-buy-day-change" style="width: 16px; height: 16px;">
                            <div class="control-label" style="margin: 0;">‰π∞ÂÖ•ÂΩìÂ§©Ê∂®Ë∑åËåÉÂõ¥</div>
                        </div>
                        <div class="slider-group">
                            <div class="slider-container">
                                <span class="slider-value" id="filter-buy-day-change-min-value">-10%</span>
                                <div class="slider-wrapper">
                                    <input type="range" id="filter-buy-day-change-min" class="slider" min="-20" max="20" step="0.1" value="-10" disabled>
                                </div>
                                <span class="slider-value" id="filter-buy-day-change-max-value">10%</span>
                                <div class="slider-wrapper">
                                    <input type="range" id="filter-buy-day-change-max" class="slider" min="-20" max="20" step="0.1" value="10" disabled>
                                </div>
                            </div>
                            <div class="slider-label-row">
                                <span>-20%</span>
                                <span>0%</span>
                                <span>20%</span>
                            </div>
                        </div>
                    </div>
                    <div class="control-group">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                            <input type="checkbox" id="filter-enable-next-day-change" style="width: 16px; height: 16px;">
                            <div class="control-label" style="margin: 0;">Á¨¨‰∫åÂ§©Ê∂®Ë∑åËåÉÂõ¥</div>
                        </div>
                        <div class="slider-group">
                            <div class="slider-container">
                                <span class="slider-value" id="filter-next-day-change-min-value">-10%</span>
                                <div class="slider-wrapper">
                                    <input type="range" id="filter-next-day-change-min" class="slider" min="-20" max="20" step="0.1" value="-10" disabled>
                                </div>
                                <span class="slider-value" id="filter-next-day-change-max-value">10%</span>
                                <div class="slider-wrapper">
                                    <input type="range" id="filter-next-day-change-max" class="slider" min="-20" max="20" step="0.1" value="10" disabled>
                                </div>
                            </div>
                            <div class="slider-label-row">
                                <span>-20%</span>
                                <span>0%</span>
                                <span>20%</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="controls-row">
                    <div class="control-group">
                        <div class="control-label">Êìç‰Ωú</div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-primary" onclick="updateCalc()" style="flex: 1;">Â∫îÁî®Á≠õÈÄâ</button>
                            <button class="btn btn-secondary" onclick="resetCalcFilters()" style="flex: 1;">ÈáçÁΩÆ</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="calc-summary" id="calc-summary">
                <div class="stat-item">
                    <div class="stat-label">ÊÄªËÇ°Á•®Êï∞</div>
                    <div class="stat-value" id="calc-total-stocks">-</div>
                </div>
            </div>
            <div style="overflow-x: auto; margin-top: 16px;">
                <table class="calc-table">
                    <thead id="calc-table-header">
                    </thead>
                    <tbody id="calc-table-body">
                    </tbody>
                </table>
            </div>
        </div>
        <div class="controls">
            <div class="controls-row">
                <div class="control-group">
                    <div class="control-label">ËÇ°Á•®‰ª£Á†Å</div>
                    <select id="filter-stock-code" class="control-input" style="width: 100%;">
                        <option value="">ÂÖ®ÈÉ®</option>
                    </select>
                </div>
                <div class="control-group">
                    <div class="control-label">ÂºÄÂßãÊó•Êúü</div>
                    <input id="filter-date-from" type="date" class="control-input" style="width: 100%;">
                </div>
                <div class="control-group">
                    <div class="control-label">ÁªìÊùüÊó•Êúü</div>
                    <input id="filter-date-to" type="date" class="control-input" style="width: 100%;">
                </div>
            </div>
            <div class="controls-row">
                <div class="control-group">
                    <div class="control-label">‰π∞ÂÖ•‰ª∑Ê†ºËåÉÂõ¥</div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="number" id="filter-timeline-price-min" class="control-input" placeholder="ÊúÄ‰Ωé‰ª∑" style="flex: 1;" min="0" step="0.01">
                        <span>-</span>
                        <input type="number" id="filter-timeline-price-max" class="control-input" placeholder="ÊúÄÈ´ò‰ª∑" style="flex: 1;" min="0" step="0.01">
                    </div>
                </div>
                <div class="control-group">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                        <input type="checkbox" id="filter-timeline-enable-buy-day-change" style="width: 16px; height: 16px;">
                        <div class="control-label" style="margin: 0;">‰π∞ÂÖ•ÂΩìÂ§©Ê∂®Ë∑åËåÉÂõ¥</div>
                    </div>
                    <div class="slider-group">
                        <div class="slider-container">
                            <span class="slider-value" id="filter-timeline-buy-day-change-min-value">-10%</span>
                            <div class="slider-wrapper">
                                <input type="range" id="filter-timeline-buy-day-change-min" class="slider" min="-20" max="20" step="0.1" value="-10" disabled>
                            </div>
                            <span class="slider-value" id="filter-timeline-buy-day-change-max-value">10%</span>
                            <div class="slider-wrapper">
                                <input type="range" id="filter-timeline-buy-day-change-max" class="slider" min="-20" max="20" step="0.1" value="10" disabled>
                            </div>
                        </div>
                        <div class="slider-label-row">
                            <span>-20%</span>
                            <span>0%</span>
                            <span>20%</span>
                        </div>
                    </div>
                </div>
                <div class="control-group">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                        <input type="checkbox" id="filter-timeline-enable-next-day-change" style="width: 16px; height: 16px;">
                        <div class="control-label" style="margin: 0;">Á¨¨‰∫åÂ§©Ê∂®Ë∑åËåÉÂõ¥</div>
                    </div>
                    <div class="slider-group">
                        <div class="slider-container">
                            <span class="slider-value" id="filter-timeline-next-day-change-min-value">-10%</span>
                            <div class="slider-wrapper">
                                <input type="range" id="filter-timeline-next-day-change-min" class="slider" min="-20" max="20" step="0.1" value="-10" disabled>
                            </div>
                            <span class="slider-value" id="filter-timeline-next-day-change-max-value">10%</span>
                            <div class="slider-wrapper">
                                <input type="range" id="filter-timeline-next-day-change-max" class="slider" min="-20" max="20" step="0.1" value="10" disabled>
                            </div>
                        </div>
                        <div class="slider-label-row">
                            <span>-20%</span>
                            <span>0%</span>
                            <span>20%</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="controls-row">
                <div class="control-group">
                    <div class="control-label">ÊòæÁ§∫ÂÜÖÂÆπ</div>
                    <div class="toggle-group">
                        <label class="toggle-item">
                            <input type="checkbox" id="toggle-buy" checked>
                            ‰π∞ÂÖ•ÁÇπ
                        </label>
                        <label class="toggle-item">
                            <input type="checkbox" id="toggle-sell-high" checked>
                            ÊúÄÈ´ò‰ª∑Á∫ø
                        </label>
                        <label class="toggle-item">
                            <input type="checkbox" id="toggle-sell-low" checked>
                            ÊúÄ‰Ωé‰ª∑Á∫ø
                        </label>
                        <label class="toggle-item">
                            <input type="checkbox" id="toggle-show-name" checked>
                            ËÇ°Á•®ÂêçÁß∞
                        </label>
                        <label class="toggle-item">
                            <input type="checkbox" id="toggle-show-profit" checked>
                            Êî∂Áõä‰ø°ÊÅØ
                        </label>
                    </div>
                </div>
            </div>
            <div class="controls-row">
                <div class="control-group">
                    <div class="control-label">Êìç‰Ωú</div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" onclick="reloadTimeline()" style="flex: 1;">Â∫îÁî®Á≠õÈÄâ</button>
                        <button class="btn btn-secondary" onclick="resetFilters()" style="flex: 1;">ÈáçÁΩÆ</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="timeline-wrapper">
            <div class="timeline-container">
                <div class="timeline-axis" id="timeline-axis">
                    <div class="timeline-content" id="timeline-content"></div>
                </div>
            </div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color legend-high"></div>
                    <span>ÊúÄÈ´ò‰ª∑Á∫ø</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-low"></div>
                    <span>ÊúÄ‰Ωé‰ª∑Á∫ø</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-buy"></div>
                    <span>‰π∞ÂÖ•ÁÇπ</span>
                </div>
            </div>
            <div class="buy-point-legend">
                <div class="buy-point-legend-title">‰π∞ÂÖ•ÁÇπÈ¢úËâ≤ËØ¥ÊòéÔºö</div>
                <div class="buy-point-legend-grid">
                    <div class="legend-item">
                        <div class="legend-color legend-buy-color-1"></div>
                        <span>‰π∞ÂÖ•ÂΩìÂ§©‰∏äÊ∂® + Á¨¨‰∫åÂ§©‰∏äÊ∂®</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-buy-color-2"></div>
                        <span>‰π∞ÂÖ•ÂΩìÂ§©‰∏ãË∑å + Á¨¨‰∫åÂ§©‰∏ãË∑å</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-buy-color-3"></div>
                        <span>‰π∞ÂÖ•ÂΩìÂ§©‰∏äÊ∂® + Á¨¨‰∫åÂ§©‰∏ãË∑å</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-buy-color-4"></div>
                        <span>‰π∞ÂÖ•ÂΩìÂ§©‰∏ãË∑å + Á¨¨‰∫åÂ§©‰∏äÊ∂®</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-buy-color-5"></div>
                        <span>‰ªÖ‰π∞ÂÖ•ÂΩìÂ§©‰∏äÊ∂®</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-buy-color-6"></div>
                        <span>‰ªÖ‰π∞ÂÖ•ÂΩìÂ§©‰∏ãË∑å</span>
                    </div>
                </div>
            </div>
            <div class="zoom-hint">üí° ÊèêÁ§∫ÔºöÂú®Êó∂Èó¥ËΩ¥‰∏äÊªöÂä®Èº†Ê†áÊªöËΩÆÂèØ‰ª•Áº©ÊîæÊó∂Èó¥Èó¥Ë∑ù</div>
        </div>
    </div>
    <script>
        let records = [];
        let selectedGroupId = null;
        let selectedRecord = null;
        let tooltipEl = null;
        let dateRange = { start: null, end: null };
        let pixelsPerDay = 2;
        let minPixelsPerDay = 0.5;
        let maxPixelsPerDay = 20;
        function createTooltip() {
            if (tooltipEl) return tooltipEl;
            const el = document.createElement("div");
            el.className = "tooltip";
            el.style.display = "none";
            document.body.appendChild(el);
            tooltipEl = el;
            return el;
        }
        function showTooltip(html, x, y) {
            const el = createTooltip();
            el.innerHTML = html;
            el.style.left = x + 12 + "px";
            el.style.top = y + 12 + "px";
            el.style.display = "block";
        }
        function hideTooltip() {
            if (tooltipEl) {
                tooltipEl.style.display = "none";
            }
        }
        function parseDate(str) {
            if (!str) return null;
            const s = str.split(" ")[0];
            const parts = s.split("-");
            if (parts.length === 3) {
                const y = parseInt(parts[0], 10);
                const m = parseInt(parts[1], 10) - 1;
                const d = parseInt(parts[2], 10);
                return new Date(y, m, d);
            }
            const p2 = s.split(".");
            if (p2.length === 3) {
                const y2 = parseInt(p2[0], 10);
                const m2 = parseInt(p2[1], 10) - 1;
                const d2 = parseInt(p2[2], 10);
                return new Date(y2, m2, d2);
            }
            return new Date(s);
        }
        function formatDate(date) {
            if (!date) return "-";
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, "0");
            const d = String(date.getDate()).padStart(2, "0");
            return y + "-" + m + "-" + d;
        }
        function formatDateShort(date) {
            if (!date) return "";
            const m = String(date.getMonth() + 1).padStart(2, "0");
            const d = String(date.getDate()).padStart(2, "0");
            return m + "-" + d;
        }
        function getDaysBetween(start, end) {
            return Math.round((end - start) / (24 * 60 * 60 * 1000));
        }
        function dateToY(date) {
            if (!dateRange.start || !date) return 0;
            const days = getDaysBetween(dateRange.start, date);
            return days * pixelsPerDay;
        }
        function colorForChange(change, isHigh) {
            if (change == null) return isHigh ? "rgba(229,57,53,0.6)" : "rgba(67,160,71,0.6)";
            const v = Math.abs(change);
            const alpha = Math.min(0.25 + v / 80, 0.95);
            if (isHigh) {
                return "rgba(229,57,53," + alpha + ")";
            }
            return "rgba(67,160,71," + alpha + ")";
        }
        function colorForBuyPoint(buyDayChangeRate, nextDayChangeRate) {
            const hasBuyDay = buyDayChangeRate !== null && buyDayChangeRate !== undefined;
            const hasNextDay = nextDayChangeRate !== null && nextDayChangeRate !== undefined;
            if (!hasBuyDay && !hasNextDay) {
                return null;
            }
            if (hasBuyDay && hasNextDay) {
                if (buyDayChangeRate > 0 && nextDayChangeRate > 0) {
                    return "#c62828";
                } else if (buyDayChangeRate < 0 && nextDayChangeRate < 0) {
                    return "#2e7d32";
                } else if (buyDayChangeRate > 0 && nextDayChangeRate < 0) {
                    return "#ff6f00";
                } else if (buyDayChangeRate < 0 && nextDayChangeRate > 0) {
                    return "#66bb6a";
                } else {
                    return "#757575";
                }
            } else if (hasBuyDay) {
                if (buyDayChangeRate > 0) {
                    return "#e53935";
                } else if (buyDayChangeRate < 0) {
                    return "#43a047";
                }
            } else if (hasNextDay) {
                if (nextDayChangeRate > 0) {
                    return "#e53935";
                } else if (nextDayChangeRate < 0) {
                    return "#43a047";
                }
            }
            return null;
        }
        function buildTooltip(rec, kind) {
            let title = "";
            if (kind === "high") {
                title = "ÊúÄÈ´ò‰ª∑Á∫ø";
            } else if (kind === "low") {
                title = "ÊúÄ‰Ωé‰ª∑Á∫ø";
            } else if (kind === "buy") {
                title = "‰π∞ÂÖ•ÁÇπ";
            }
            let html = '<div class="tooltip-title">' + title + "</div>";
            html += '<div class="tooltip-row"><span class="tooltip-label">‰ª£Á†Å</span><span>' + (rec.stockCode || "-") + "</span></div>";
            if (document.getElementById("toggle-show-name").checked) {
                html += '<div class="tooltip-row"><span class="tooltip-label">ÂêçÁß∞</span><span>' + (rec.stockName || "-") + "</span></div>";
            }
            if (rec.buyDate) {
                html += '<div class="tooltip-row"><span class="tooltip-label">‰π∞ÂÖ•Êó•</span><span>' + formatDate(rec.buyDate) + "</span></div>";
            }
            if (rec.buyPrice != null) {
                html += '<div class="tooltip-row"><span class="tooltip-label">‰π∞ÂÖ•‰ª∑</span><span>' + rec.buyPrice.toFixed(2) + "</span></div>";
            }
            if (kind === "buy") {
                if (rec.buyDayChangeRate !== null && rec.buyDayChangeRate !== undefined) {
                    const sign = rec.buyDayChangeRate > 0 ? "+" : "";
                    const color = rec.buyDayChangeRate >= 0 ? "#e53935" : "#43a047";
                    html += '<div class="tooltip-row"><span class="tooltip-label">‰π∞ÂÖ•ÂΩìÂ§©Ê∂®Ë∑å</span><span style="color:' + color + ';">' + sign + rec.buyDayChangeRate.toFixed(2) + "%</span></div>";
                }
                if (rec.nextDayChangeRate !== null && rec.nextDayChangeRate !== undefined) {
                    const sign2 = rec.nextDayChangeRate > 0 ? "+" : "";
                    const color2 = rec.nextDayChangeRate >= 0 ? "#e53935" : "#43a047";
                    html += '<div class="tooltip-row"><span class="tooltip-label">Á¨¨‰∫åÂ§©Ê∂®Ë∑å</span><span style="color:' + color2 + ';">' + sign2 + rec.nextDayChangeRate.toFixed(2) + "%</span></div>";
                }
            }
            if (kind === "high" && rec.highDate) {
                html += '<div class="tooltip-row"><span class="tooltip-label">ÂçñÂá∫Êó•</span><span>' + formatDate(rec.highDate) + "</span></div>";
                if (rec.highPrice != null) {
                    html += '<div class="tooltip-row"><span class="tooltip-label">ÂçñÂá∫‰ª∑</span><span>' + rec.highPrice.toFixed(2) + "</span></div>";
                }
                if (rec.highDays != null) {
                    html += '<div class="tooltip-row"><span class="tooltip-label">ÊåÅÊúâÊó∂Èó¥</span><span>' + rec.highDays + " Â§©</span></div>";
                }
                if (document.getElementById("toggle-show-profit").checked && rec.highChange != null) {
                    const c = rec.highChange;
                    const sign = c > 0 ? "+" : "";
                    const color = c >= 0 ? "#e53935" : "#43a047";
                    html += '<div class="tooltip-row"><span class="tooltip-label">Êî∂Áõä</span><span style="color:' + color + ';">' + sign + c.toFixed(2) + "%</span></div>";
                }
            }
            if (kind === "low" && rec.lowDate) {
                html += '<div class="tooltip-row"><span class="tooltip-label">ÂçñÂá∫Êó•</span><span>' + formatDate(rec.lowDate) + "</span></div>";
                if (rec.lowPrice != null) {
                    html += '<div class="tooltip-row"><span class="tooltip-label">ÂçñÂá∫‰ª∑</span><span>' + rec.lowPrice.toFixed(2) + "</span></div>";
                }
                if (rec.lowDays != null) {
                    html += '<div class="tooltip-row"><span class="tooltip-label">ÊåÅÊúâÊó∂Èó¥</span><span>' + rec.lowDays + " Â§©</span></div>";
                }
                if (document.getElementById("toggle-show-profit").checked && rec.lowChange != null) {
                    const c2 = rec.lowChange;
                    const sign2 = c2 > 0 ? "+" : "";
                    const color2 = c2 >= 0 ? "#e53935" : "#43a047";
                    html += '<div class="tooltip-row"><span class="tooltip-label">Êî∂Áõä</span><span style="color:' + color2 + ';">' + sign2 + c2.toFixed(2) + "%</span></div>";
                }
            }
            return html;
        }
        function highlightGroup(groupId) {
            const elems = document.querySelectorAll(".stock-elem");
            elems.forEach(el => {
                const g = el.dataset.groupId;
                if (!g) return;
                if (groupId && g === groupId) {
                    el.style.opacity = "1";
                } else if (groupId) {
                    el.style.opacity = "0.18";
                } else {
                    el.style.opacity = "1";
                }
            });
        }
        function bindElemEvents(el, rec, kind) {
            const isPoint = el.classList.contains("stock-point");
            el.addEventListener("mouseenter", function(evt) {
                if (!selectedGroupId) {
                    el.style.opacity = "1";
                    if (isPoint) {
                        el.style.transform = "translate(-50%, -50%) scale(1.5)";
                    } else {
                        el.style.transform = "scaleX(1.5)";
                    }
                }
                const html = buildTooltip(rec, kind);
                showTooltip(html, evt.clientX, evt.clientY);
            });
            el.addEventListener("mouseleave", function() {
                if (!selectedGroupId) {
                    el.style.opacity = "";
                    if (isPoint) {
                        el.style.transform = "translate(-50%, -50%)";
                    } else {
                        el.style.transform = "";
                    }
                }
                hideTooltip();
            });
            el.addEventListener("click", function() {
                if (selectedGroupId === rec.groupId) {
                    selectedGroupId = null;
                } else {
                    selectedGroupId = rec.groupId;
                }
                renderTimeline();
            });
        }
        function calculateProfitForStock(rec, profitTarget, stopLoss) {
            if (!rec.buyPrice) return null;
            const buyPrice = rec.buyPrice;
            const highPrice = rec.highPrice;
            const lowPrice = rec.lowPrice;
            const highDays = rec.highDays || 999999;
            const lowDays = rec.lowDays || 999999;
            const profitPrice = buyPrice * (1 + profitTarget / 100);
            const lossPrice = buyPrice * (1 + stopLoss / 100);
            const canReachProfit = highPrice && highPrice >= profitPrice;
            const canReachLoss = lowPrice && lowPrice <= lossPrice;
            if (!canReachProfit && !canReachLoss) {
                return null;
            }
            let firstHit = null;
            let firstHitDays = 999999;
            if (canReachProfit && highDays < firstHitDays) {
                firstHit = "profit";
                firstHitDays = highDays;
            }
            if (canReachLoss && lowDays < firstHitDays) {
                firstHit = "loss";
                firstHitDays = lowDays;
            }
            if (firstHit === "profit") {
                return { profit: profitTarget, days: firstHitDays, type: "profit" };
            } else if (firstHit === "loss") {
                return { profit: stopLoss, days: firstHitDays, type: "loss" };
            }
            return null;
        }
        function getFilteredRecords() {
            const dateRangeInput = document.getElementById("filter-date-range").value;
            const daysMinInput = document.getElementById("filter-days-min").value;
            const daysMaxInput = document.getElementById("filter-days-max").value;
            const priceMinInput = document.getElementById("filter-price-min").value;
            const priceMaxInput = document.getElementById("filter-price-max").value;
            const highChangeMinInput = document.getElementById("filter-high-change-min").value;
            const highChangeMaxInput = document.getElementById("filter-high-change-max").value;
            const buyDayChangeMinInput = document.getElementById("filter-buy-day-change-min").value;
            const buyDayChangeMaxInput = document.getElementById("filter-buy-day-change-max").value;
            const nextDayChangeMinInput = document.getElementById("filter-next-day-change-min").value;
            const nextDayChangeMaxInput = document.getElementById("filter-next-day-change-max").value;
            const daysMin = daysMinInput ? parseFloat(daysMinInput) : 0;
            const daysMax = daysMaxInput ? parseFloat(daysMaxInput) : Infinity;
            const priceMin = priceMinInput ? parseFloat(priceMinInput) : 0;
            const priceMax = priceMaxInput ? parseFloat(priceMaxInput) : Infinity;
            const highChangeMin = highChangeMinInput ? parseFloat(highChangeMinInput) : -Infinity;
            const highChangeMax = highChangeMaxInput ? parseFloat(highChangeMaxInput) : Infinity;
            const buyDayChangeMin = buyDayChangeMinInput ? parseFloat(buyDayChangeMinInput) : -Infinity;
            const buyDayChangeMax = buyDayChangeMaxInput ? parseFloat(buyDayChangeMaxInput) : Infinity;
            const nextDayChangeMin = nextDayChangeMinInput ? parseFloat(nextDayChangeMinInput) : -Infinity;
            const nextDayChangeMax = nextDayChangeMaxInput ? parseFloat(nextDayChangeMaxInput) : Infinity;
            let dateThreshold = null;
            if (dateRangeInput) {
                const days = parseInt(dateRangeInput);
                const thresholdDate = new Date();
                thresholdDate.setDate(thresholdDate.getDate() - days);
                thresholdDate.setHours(0, 0, 0, 0);
                dateThreshold = thresholdDate;
            }
            return records.filter(rec => {
                if (!rec.buyPrice) return false;
                if (dateThreshold && rec.buyDate) {
                    const buyDate = new Date(rec.buyDate);
                    buyDate.setHours(0, 0, 0, 0);
                    if (buyDate < dateThreshold) return false;
                }
                if (priceMinInput && rec.buyPrice < priceMin) return false;
                if (priceMaxInput && rec.buyPrice > priceMax) return false;
                if (rec.highChange !== null) {
                    if (highChangeMinInput && rec.highChange < highChangeMin) return false;
                    if (highChangeMaxInput && rec.highChange > highChangeMax) return false;
                }
                const enableBuyDayChange = document.getElementById("filter-enable-buy-day-change").checked;
                if (enableBuyDayChange) {
                    if (rec.buyDayChangeRate === null || rec.buyDayChangeRate === undefined) return false;
                    if (buyDayChangeMinInput && rec.buyDayChangeRate < buyDayChangeMin) return false;
                    if (buyDayChangeMaxInput && rec.buyDayChangeRate > buyDayChangeMax) return false;
                }
                const enableNextDayChange = document.getElementById("filter-enable-next-day-change").checked;
                if (enableNextDayChange) {
                    if (rec.nextDayChangeRate === null || rec.nextDayChangeRate === undefined) return false;
                    if (nextDayChangeMinInput && rec.nextDayChangeRate < nextDayChangeMin) return false;
                    if (nextDayChangeMaxInput && rec.nextDayChangeRate > nextDayChangeMax) return false;
                }
                const maxDays = Math.max(rec.highDays || 0, rec.lowDays || 0);
                if (daysMinInput && maxDays < daysMin) return false;
                if (daysMaxInput && maxDays > daysMax) return false;
                return true;
            });
        }
        function updateSliderValue(sliderId, valueId) {
            const slider = document.getElementById(sliderId);
            const valueEl = document.getElementById(valueId);
            if (slider && valueEl) {
                const value = parseFloat(slider.value);
                valueEl.textContent = (value > 0 ? "+" : "") + value.toFixed(1) + "%";
            }
        }
        function resetCalcFilters() {
            document.getElementById("filter-date-range").value = "";
            document.getElementById("filter-days-min").value = "10";
            document.getElementById("filter-days-max").value = "";
            document.getElementById("filter-price-min").value = "";
            document.getElementById("filter-price-max").value = "";
            document.getElementById("filter-high-change-min").value = "";
            document.getElementById("filter-high-change-max").value = "";
            document.getElementById("filter-enable-buy-day-change").checked = false;
            document.getElementById("filter-enable-next-day-change").checked = false;
            document.getElementById("filter-buy-day-change-min").value = "-10";
            document.getElementById("filter-buy-day-change-max").value = "10";
            document.getElementById("filter-next-day-change-min").value = "-10";
            document.getElementById("filter-next-day-change-max").value = "10";
            document.getElementById("filter-confidence").value = "80";
            document.getElementById("filter-buy-day-change-min").disabled = true;
            document.getElementById("filter-buy-day-change-max").disabled = true;
            document.getElementById("filter-next-day-change-min").disabled = true;
            document.getElementById("filter-next-day-change-max").disabled = true;
            updateSliderValue("filter-buy-day-change-min", "filter-buy-day-change-min-value");
            updateSliderValue("filter-buy-day-change-max", "filter-buy-day-change-max-value");
            updateSliderValue("filter-next-day-change-min", "filter-next-day-change-min-value");
            updateSliderValue("filter-next-day-change-max", "filter-next-day-change-max-value");
            updateCalc();
        }
        function updateCalc() {
            const filteredRecords = getFilteredRecords();
            const profitTargets = [];
            const stopLosses = [];
            for (let i = 2; i <= 30; i += 2) {
                profitTargets.push(i);
            }
            for (let i = -2; i >= -30; i -= 2) {
                stopLosses.push(i);
            }
            const thead = document.getElementById("calc-table-header");
            const tbody = document.getElementById("calc-table-body");
            thead.innerHTML = "";
            tbody.innerHTML = "";
            const headerRow = document.createElement("tr");
            headerRow.innerHTML = "<th>Ê≠¢Êçü\\Ê≠¢Áõà</th>";
            profitTargets.forEach(pt => {
                const th = document.createElement("th");
                th.className = "text-center";
                th.textContent = "+" + pt + "%";
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            let totalStocks = 0;
            filteredRecords.forEach(rec => {
                if (rec.buyPrice) totalStocks++;
            });
            document.getElementById("calc-total-stocks").textContent = totalStocks;
            const results = [];
            const stockDetails = [];
            stopLosses.forEach((sl, slIdx) => {
                const row = document.createElement("tr");
                const labelCell = document.createElement("td");
                labelCell.textContent = sl + "%";
                labelCell.style.fontWeight = "600";
                row.appendChild(labelCell);
                const rowResults = [];
                const rowDetails = [];
                profitTargets.forEach((pt, ptIdx) => {
                    let totalProfit = 0;
                    let count = 0;
                    let profitCount = 0;
                    let lossCount = 0;
                    const stocks = [];
                    filteredRecords.forEach(rec => {
                        const result = calculateProfitForStock(rec, pt, sl);
                        if (result !== null) {
                            totalProfit += result.profit;
                            count++;
                            if (result.type === "profit") {
                                profitCount++;
                            } else {
                                lossCount++;
                            }
                            stocks.push({
                                code: rec.stockCode || "-",
                                name: rec.stockName || "-",
                                profit: result.profit,
                                days: result.days,
                                type: result.type
                            });
                        }
                    });
                    const avgProfit = count > 0 ? totalProfit / count : null;
                    rowResults.push(avgProfit);
                    rowDetails.push(stocks);
                    const cell = document.createElement("td");
                    cell.style.cursor = "pointer";
                    cell.title = "";
                    if (avgProfit !== null) {
                        const hitRate = totalStocks > 0 ? (profitCount + lossCount) / totalStocks : 0;
                        const confidenceFilter = parseFloat(document.getElementById("filter-confidence").value) || 80;
                        const meetsConfidence = hitRate * 100 >= confidenceFilter;
                        cell.className = "text-center " + (avgProfit >= 0 ? "profit-positive" : "profit-negative");
                        if (meetsConfidence) {
                            cell.style.backgroundColor = "#e1bee7";
                        }
                        const profitSpan = '<span style="color:#b71c1c;opacity:0.7;font-size:11px;">' + profitCount + '</span>';
                        const lossSpan = '<span style="color:#1b5e20;opacity:0.7;font-size:11px;">' + lossCount + '</span>';
                        cell.innerHTML = (avgProfit > 0 ? "+" : "") + avgProfit.toFixed(2) + "% (" + profitSpan + ", " + lossSpan + ")";
                        cell.dataset.stocks = JSON.stringify(stocks);
                        cell.addEventListener("mouseenter", function(e) {
                            const stocksData = JSON.parse(this.dataset.stocks || "[]");
                            if (stocksData.length > 0) {
                                let html = '<div class="tooltip-title">ËÇ°Á•®ËØ¶ÊÉÖÔºà' + stocksData.length + "Âè™Ôºâ</div>";
                                html += '<div class="tooltip-stocks">';
                                const displayCount = Math.min(9, stocksData.length);
                                for (let i = 0; i < displayCount; i++) {
                                    const s = stocksData[i];
                                    html += '<div class="tooltip-stock-item">';
                                    html += '<div class="tooltip-stock-code">' + s.code + "</div>";
                                    html += '<div class="tooltip-stock-name">' + (s.name || "-") + "</div>";
                                    html += '<div class="tooltip-stock-info">ÊåÅÊúâ: ' + s.days + " Â§©</div>";
                                    html += '<div class="tooltip-stock-info" style="color:' + (s.profit >= 0 ? "#e53935" : "#43a047") + ';">Êî∂Áõä: ' + (s.profit > 0 ? "+" : "") + s.profit.toFixed(2) + "%</div>";
                                    html += '<div class="tooltip-stock-info">' + (s.type === "profit" ? "Ê≠¢Áõà" : "Ê≠¢Êçü") + "</div>";
                                    html += "</div>";
                                }
                                html += "</div>";
                                if (stocksData.length > 9) {
                                    html += '<div style="margin-top:8px;font-size:11px;color:#999;">ËøòÊúâ ' + (stocksData.length - 9) + " Âè™ËÇ°Á•®ÔºåÊªöÂä®Êü•Áúã</div>";
                                }
                                showTooltip(html, e.clientX, e.clientY);
                            }
                        });
                        cell.addEventListener("mouseleave", function() {
                            hideTooltip();
                        });
                    } else {
                        cell.className = "text-center";
                        cell.textContent = "-";
                    }
                    row.appendChild(cell);
                });
                results.push(rowResults);
                stockDetails.push(rowDetails);
                tbody.appendChild(row);
            });
            const allResults = [];
            results.forEach((row, r) => {
                row.forEach((val, c) => {
                    if (val !== null && typeof val === 'number') {
                        allResults.push({ value: val, row: r, col: c });
                    }
                });
            });
            allResults.sort((a, b) => b.value - a.value);
            const top10 = allResults.slice(0, 10);
            const bottom10 = allResults.slice(-10);
            const rows = tbody.querySelectorAll("tr");
            results.forEach((row, r) => {
                const cells = rows[r].querySelectorAll("td");
                row.forEach((val, c) => {
                    const cell = cells[c + 1];
                    const isTop10 = top10.some(item => item.row === r && item.col === c);
                    const isBottom10 = bottom10.some(item => item.row === r && item.col === c);
                    const currentBg = cell.style.backgroundColor;
                    const isHighHitRate = currentBg === "rgb(225, 190, 231)" || currentBg === "#e1bee7";
                    if (isTop10 && !isHighHitRate) {
                        cell.style.backgroundColor = "#fff3cd";
                        cell.style.fontWeight = "700";
                    } else if (isBottom10 && !isHighHitRate) {
                        cell.style.backgroundColor = "#f8d7da";
                        cell.style.fontWeight = "700";
                    } else if (isHighHitRate) {
                        cell.style.fontWeight = "600";
                    }
                });
            });
        }
        function renderTimeMarkers() {
            const content = document.getElementById("timeline-content");
            const markers = content.querySelectorAll(".time-marker");
            markers.forEach(m => m.remove());
            if (!dateRange.start || !dateRange.end) return;
            const dayMs = 24 * 60 * 60 * 1000;
            let currentDate = new Date(dateRange.start);
            currentDate.setHours(0, 0, 0, 0);
            const endDate = new Date(dateRange.end);
            endDate.setHours(23, 59, 59, 999);
            let lastLabelY = -Infinity;
            const minLabelSpacing = 22;
            while (currentDate <= endDate) {
                const y = dateToY(currentDate);
                const isMajor = currentDate.getDate() === 1;
                const marker = document.createElement("div");
                marker.className = "time-marker" + (isMajor ? " major" : "");
                marker.style.top = y + "px";
                const needLabel = isMajor || (y - lastLabelY >= minLabelSpacing);
                if (needLabel) {
                    const label = document.createElement("div");
                    label.className = "time-label" + (isMajor ? " major" : "");
                    if (isMajor) {
                        label.textContent = formatDate(currentDate);
                    } else {
                        label.textContent = formatDateShort(currentDate);
                    }
                    marker.appendChild(label);
                    lastLabelY = y;
                }
                content.appendChild(marker);
                currentDate = new Date(currentDate.getTime() + dayMs);
            }
        }
        function getStockTimeRange(rec) {
            const dates = [];
            if (rec.buyDate) dates.push(rec.buyDate);
            if (rec.highDate) dates.push(rec.highDate);
            if (rec.lowDate) dates.push(rec.lowDate);
            if (dates.length === 0) return null;
            return {
                start: new Date(Math.min(...dates)),
                end: new Date(Math.max(...dates))
            };
        }
        function rangesOverlap(range1, range2) {
            if (!range1 || !range2) return false;
            return range1.start <= range2.end && range2.start <= range1.end;
        }
        function assignColumns(records) {
            const columns = [];
            records.forEach(rec => {
                const range = getStockTimeRange(rec);
                let assigned = false;
                for (let i = 0; i < columns.length; i++) {
                    const canFit = !columns[i].some(existingRec => {
                        const existingRange = getStockTimeRange(existingRec);
                        return rangesOverlap(range, existingRange);
                    });
                    if (canFit) {
                        columns[i].push(rec);
                        assigned = true;
                        break;
                    }
                }
                if (!assigned) {
                    columns.push([rec]);
                }
            });
            return columns;
        }
        function renderStockLines() {
            const content = document.getElementById("timeline-content");
            const lines = content.querySelectorAll(".stock-line");
            lines.forEach(l => l.remove());
            const points = content.querySelectorAll(".stock-point");
            points.forEach(p => p.remove());
            const visibleRecords = records.filter(rec => !selectedGroupId || rec.groupId === selectedGroupId);
            const screenWidth = window.innerWidth || 1400;
            const startX = 80;
            const endX = screenWidth - 40;
            const availableWidth = endX - startX;
            const minSpacing = 30;
            const columns = assignColumns(visibleRecords);
            const columnWidth = Math.max(minSpacing, availableWidth / Math.max(1, columns.length));
            columns.forEach((columnRecords, colIndex) => {
                const baseX = startX + (colIndex * columnWidth);
                columnRecords.forEach((rec) => {
                    const showHigh = document.getElementById("toggle-sell-high").checked;
                    const showLow = document.getElementById("toggle-sell-low").checked;
                    const showBuy = document.getElementById("toggle-buy").checked;
                    const highLineX = baseX;
                    const lowLineX = baseX + 6;
                    const lineWidth = 8;
                    const buyRectWidth = showHigh && showLow ? 14 : 8;
                    const buyRectX = showHigh && showLow ? (highLineX + lowLineX + lineWidth) / 2 : (showHigh ? highLineX + lineWidth / 2 : lowLineX + lineWidth / 2);
                    if (rec.buyDate && rec.highDate && showHigh) {
                        const buyY = dateToY(rec.buyDate);
                        const highY = dateToY(rec.highDate);
                        const startY = Math.min(buyY, highY);
                        const endY = Math.max(buyY, highY);
                        const height = endY - startY;
                        if (height > 0) {
                            const line = document.createElement("div");
                            line.className = "stock-line stock-line-high stock-elem";
                            line.dataset.groupId = rec.groupId;
                            line.style.left = highLineX + "px";
                            line.style.top = startY + "px";
                            line.style.height = height + "px";
                            line.style.backgroundColor = colorForChange(rec.highChange, true);
                            content.appendChild(line);
                            bindElemEvents(line, rec, "high");
                        }
                        if (rec.highDate) {
                            const highY2 = dateToY(rec.highDate);
                            const highPoint = document.createElement("div");
                            highPoint.className = "stock-point stock-point-high stock-elem";
                            highPoint.dataset.groupId = rec.groupId;
                            highPoint.style.left = (highLineX + lineWidth / 2) + "px";
                            highPoint.style.top = highY2 + "px";
                            content.appendChild(highPoint);
                            bindElemEvents(highPoint, rec, "high");
                        }
                    }
                    if (rec.buyDate && rec.lowDate && showLow) {
                        const buyY = dateToY(rec.buyDate);
                        const lowY = dateToY(rec.lowDate);
                        const startY = Math.min(buyY, lowY);
                        const endY = Math.max(buyY, lowY);
                        const height = endY - startY;
                        if (height > 0) {
                            const line = document.createElement("div");
                            line.className = "stock-line stock-line-low stock-elem";
                            line.dataset.groupId = rec.groupId;
                            line.style.left = lowLineX + "px";
                            line.style.top = startY + "px";
                            line.style.height = height + "px";
                            line.style.backgroundColor = colorForChange(rec.lowChange, false);
                            content.appendChild(line);
                            bindElemEvents(line, rec, "low");
                        }
                        if (rec.lowDate) {
                            const lowY2 = dateToY(rec.lowDate);
                            const lowPoint = document.createElement("div");
                            lowPoint.className = "stock-point stock-point-low stock-elem";
                            lowPoint.dataset.groupId = rec.groupId;
                            lowPoint.style.left = (lowLineX + lineWidth / 2) + "px";
                            lowPoint.style.top = lowY2 + "px";
                            content.appendChild(lowPoint);
                            bindElemEvents(lowPoint, rec, "low");
                        }
                    }
                    if (showBuy && rec.buyDate) {
                        const buyY2 = dateToY(rec.buyDate);
                        const buyPoint = document.createElement("div");
                        buyPoint.className = "stock-point stock-point-buy rect stock-elem";
                        buyPoint.dataset.groupId = rec.groupId;
                        buyPoint.style.width = buyRectWidth + "px";
                        buyPoint.style.left = buyRectX + "px";
                        buyPoint.style.top = buyY2 + "px";
                        const buyPointColor = colorForBuyPoint(rec.buyDayChangeRate, rec.nextDayChangeRate);
                        if (buyPointColor) {
                            buyPoint.style.backgroundColor = buyPointColor;
                        }
                        content.appendChild(buyPoint);
                        bindElemEvents(buyPoint, rec, "buy");
                    }
                });
            });
            if (selectedGroupId) {
                highlightGroup(selectedGroupId);
            } else {
                highlightGroup(null);
            }
        }
        function renderTimeline() {
            const content = document.getElementById("timeline-content");
            renderTimeMarkers();
            const totalDays = getDaysBetween(dateRange.start, dateRange.end);
            const totalHeight = totalDays * pixelsPerDay;
            content.style.height = totalHeight + "px";
            renderStockLines();
        }
        function setupZoom() {
            const axis = document.getElementById("timeline-axis");
            axis.addEventListener("wheel", function(e) {
                if (e.ctrlKey) {
                    e.preventDefault();
                    const rect = axis.getBoundingClientRect();
                    const mouseY = e.clientY - rect.top;
                    const scrollTop = axis.scrollTop;
                    const mouseYInContent = mouseY + scrollTop;
                    const oldPixelsPerDay = pixelsPerDay;
                    const mouseDate = yToDate(mouseYInContent, oldPixelsPerDay);
                    const delta = e.deltaY > 0 ? -0.1 : 0.1;
                    pixelsPerDay = Math.max(minPixelsPerDay, Math.min(maxPixelsPerDay, pixelsPerDay * (1 + delta)));
                    if (pixelsPerDay !== oldPixelsPerDay && mouseDate) {
                        renderTimeline();
                        const newMouseY = dateToY(mouseDate);
                        const newScrollTop = newMouseY - mouseY;
                        axis.scrollTop = Math.max(0, newScrollTop);
                    }
                }
            });
        }
        function yToDate(y, ppd) {
            if (!dateRange.start) return null;
            const pixelsPerDayValue = ppd || pixelsPerDay;
            const days = y / pixelsPerDayValue;
            const date = new Date(dateRange.start.getTime() + days * 24 * 60 * 60 * 1000);
            return date;
        }
        async function loadStats() {
            try {
                const res = await fetch("/api/stats");
                const data = await res.json();
                document.getElementById("stat-total").textContent = data.total_signals || 0;
                document.getElementById("stat-stocks").textContent = data.total_stocks || 0;
                document.getElementById("stat-success").textContent = (data.avg_success_rate || 0) + "%";
                const highest = data.avg_highest_change || 0;
                document.getElementById("stat-highest").textContent = (highest > 0 ? "+" : "") + highest.toFixed(2) + "%";
            } catch (error) {
                console.error("Failed to load stats:", error);
            }
        }
        async function loadStockCodes() {
            try {
                const res = await fetch("/api/stock-codes");
                const data = await res.json();
                const select = document.getElementById("filter-stock-code");
                data.stock_codes.forEach(item => {
                    const option = document.createElement("option");
                    option.value = item.code;
                    option.textContent = item.code + (item.name ? " - " + item.name : "");
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Failed to load stock codes:", error);
            }
        }
        async function reloadTimeline() {
            const stockCode = document.getElementById("filter-stock-code").value;
            const dateFrom = document.getElementById("filter-date-from").value;
            const dateTo = document.getElementById("filter-date-to").value;
            const params = new URLSearchParams();
            if (stockCode) params.append("stock_code", stockCode);
            if (dateFrom) params.append("date_from", dateFrom);
            if (dateTo) params.append("date_to", dateTo);
            const res = await fetch("/api/calendar/events?" + params.toString());
            const data = await res.json();
            const events = data.events || [];
            records = [];
            const priceMinInput = document.getElementById("filter-timeline-price-min").value;
            const priceMaxInput = document.getElementById("filter-timeline-price-max").value;
            const buyDayChangeMinInput = document.getElementById("filter-timeline-buy-day-change-min").value;
            const buyDayChangeMaxInput = document.getElementById("filter-timeline-buy-day-change-max").value;
            const nextDayChangeMinInput = document.getElementById("filter-timeline-next-day-change-min").value;
            const nextDayChangeMaxInput = document.getElementById("filter-timeline-next-day-change-max").value;
            const priceMin = priceMinInput ? parseFloat(priceMinInput) : 0;
            const priceMax = priceMaxInput ? parseFloat(priceMaxInput) : Infinity;
            const buyDayChangeMin = buyDayChangeMinInput ? parseFloat(buyDayChangeMinInput) : -Infinity;
            const buyDayChangeMax = buyDayChangeMaxInput ? parseFloat(buyDayChangeMaxInput) : Infinity;
            const nextDayChangeMin = nextDayChangeMinInput ? parseFloat(nextDayChangeMinInput) : -Infinity;
            const nextDayChangeMax = nextDayChangeMaxInput ? parseFloat(nextDayChangeMaxInput) : Infinity;
            events.forEach((e, idx) => {
                const buyPrice = e.insert_price != null ? Number(e.insert_price) : null;
                if (priceMinInput && (buyPrice === null || buyPrice < priceMin)) return;
                if (priceMaxInput && (buyPrice === null || buyPrice > priceMax)) return;
                const enableBuyDayChange = document.getElementById("filter-timeline-enable-buy-day-change").checked;
                if (enableBuyDayChange) {
                    const buyDayChangeRate = e.buy_day_change_rate != null ? Number(e.buy_day_change_rate) : null;
                    if (buyDayChangeRate === null || buyDayChangeRate === undefined) return;
                    if (buyDayChangeRate < buyDayChangeMin || buyDayChangeRate > buyDayChangeMax) return;
                }
                const enableNextDayChange = document.getElementById("filter-timeline-enable-next-day-change").checked;
                if (enableNextDayChange) {
                    const nextDayChangeRate = e.next_day_change_rate != null ? Number(e.next_day_change_rate) : null;
                    if (nextDayChangeRate === null || nextDayChangeRate === undefined) return;
                    if (nextDayChangeRate < nextDayChangeMin || nextDayChangeRate > nextDayChangeMax) return;
                }
                const buyDate = parseDate(e.insert_date);
                const highDate = parseDate(e.highest_price_date);
                const lowDate = parseDate(e.lowest_price_date);
                const rec = {
                    groupId: e.stock_code + "_" + idx,
                    stockCode: e.stock_code,
                    stockName: e.stock_name,
                    buyDate: buyDate,
                    buyPrice: buyPrice,
                    highDate: highDate,
                    highPrice: e.highest_price != null ? Number(e.highest_price) : null,
                    highChange: e.highest_change_rate != null ? Number(e.highest_change_rate) : null,
                    highDays: e.highest_days != null ? Number(e.highest_days) : null,
                    lowDate: lowDate,
                    lowPrice: e.lowest_price != null ? Number(e.lowest_price) : null,
                    lowChange: e.lowest_change_rate != null ? Number(e.lowest_change_rate) : null,
                    lowDays: e.lowest_days != null ? Number(e.lowest_days) : null,
                    buyDayChangeRate: e.buy_day_change_rate != null ? Number(e.buy_day_change_rate) : null,
                    nextDayChangeRate: e.next_day_change_rate != null ? Number(e.next_day_change_rate) : null
                };
                records.push(rec);
            });
            if (records.length === 0) {
                dateRange.start = new Date();
                dateRange.end = new Date();
            } else {
                const allDates = [];
                records.forEach(rec => {
                    if (rec.buyDate) allDates.push(rec.buyDate);
                    if (rec.highDate) allDates.push(rec.highDate);
                    if (rec.lowDate) allDates.push(rec.lowDate);
                });
                const minDate = new Date(Math.min(...allDates));
                const maxDate = new Date(Math.max(...allDates));
                dateRange.start = new Date(minDate);
                dateRange.start.setDate(dateRange.start.getDate() - 14);
                dateRange.start.setHours(0, 0, 0, 0);
                dateRange.end = new Date(maxDate);
                dateRange.end.setDate(dateRange.end.getDate() + 14);
                dateRange.end.setHours(23, 59, 59, 999);
            }
            const screenHeight = window.innerHeight || 800;
            const daysToShow = 60;
            pixelsPerDay = Math.max(0.5, Math.min(20, screenHeight / daysToShow));
            renderTimeline();
            updateCalc();
        }
        function resetFilters() {
            document.getElementById("filter-stock-code").value = "";
            document.getElementById("filter-date-from").value = "";
            document.getElementById("filter-date-to").value = "";
            document.getElementById("filter-timeline-price-min").value = "";
            document.getElementById("filter-timeline-price-max").value = "";
            document.getElementById("filter-timeline-enable-buy-day-change").checked = false;
            document.getElementById("filter-timeline-enable-next-day-change").checked = false;
            document.getElementById("filter-timeline-buy-day-change-min").value = "-10";
            document.getElementById("filter-timeline-buy-day-change-max").value = "10";
            document.getElementById("filter-timeline-next-day-change-min").value = "-10";
            document.getElementById("filter-timeline-next-day-change-max").value = "10";
            document.getElementById("filter-timeline-buy-day-change-min").disabled = true;
            document.getElementById("filter-timeline-buy-day-change-max").disabled = true;
            document.getElementById("filter-timeline-next-day-change-min").disabled = true;
            document.getElementById("filter-timeline-next-day-change-max").disabled = true;
            updateSliderValue("filter-timeline-buy-day-change-min", "filter-timeline-buy-day-change-min-value");
            updateSliderValue("filter-timeline-buy-day-change-max", "filter-timeline-buy-day-change-max-value");
            updateSliderValue("filter-timeline-next-day-change-min", "filter-timeline-next-day-change-min-value");
            updateSliderValue("filter-timeline-next-day-change-max", "filter-timeline-next-day-change-max-value");
            document.getElementById("toggle-buy").checked = true;
            document.getElementById("toggle-sell-high").checked = true;
            document.getElementById("toggle-sell-low").checked = true;
            document.getElementById("toggle-show-name").checked = true;
            document.getElementById("toggle-show-profit").checked = true;
            selectedGroupId = null;
            reloadTimeline();
        }
        function setupSliderListeners() {
            const sliders = [
                { id: "filter-buy-day-change-min", valueId: "filter-buy-day-change-min-value", checkboxId: "filter-enable-buy-day-change" },
                { id: "filter-buy-day-change-max", valueId: "filter-buy-day-change-max-value", checkboxId: "filter-enable-buy-day-change" },
                { id: "filter-next-day-change-min", valueId: "filter-next-day-change-min-value", checkboxId: "filter-enable-next-day-change" },
                { id: "filter-next-day-change-max", valueId: "filter-next-day-change-max-value", checkboxId: "filter-enable-next-day-change" },
                { id: "filter-timeline-buy-day-change-min", valueId: "filter-timeline-buy-day-change-min-value", checkboxId: "filter-timeline-enable-buy-day-change" },
                { id: "filter-timeline-buy-day-change-max", valueId: "filter-timeline-buy-day-change-max-value", checkboxId: "filter-timeline-enable-buy-day-change" },
                { id: "filter-timeline-next-day-change-min", valueId: "filter-timeline-next-day-change-min-value", checkboxId: "filter-timeline-enable-next-day-change" },
                { id: "filter-timeline-next-day-change-max", valueId: "filter-timeline-next-day-change-max-value", checkboxId: "filter-timeline-enable-next-day-change" }
            ];
            sliders.forEach(({ id, valueId, checkboxId }) => {
                const slider = document.getElementById(id);
                const checkbox = document.getElementById(checkboxId);
                if (slider) {
                    updateSliderValue(id, valueId);
                    slider.addEventListener("input", function() {
                        updateSliderValue(id, valueId);
                        if (id.startsWith("filter-timeline-")) {
                            reloadTimeline();
                        } else {
                            updateCalc();
                        }
                    });
                }
                if (checkbox && slider) {
                    checkbox.addEventListener("change", function() {
                        slider.disabled = !checkbox.checked;
                        if (id.startsWith("filter-timeline-")) {
                            reloadTimeline();
                        } else {
                            updateCalc();
                        }
                    });
                }
            });
        }
        document.addEventListener("DOMContentLoaded", function() {
            setupZoom();
            loadStats();
            loadStockCodes();
            setupSliderListeners();
            reloadTimeline();
            document.getElementById("toggle-buy").addEventListener("change", function() {
                renderTimeline();
            });
            document.getElementById("toggle-sell-high").addEventListener("change", function() {
                renderTimeline();
            });
            document.getElementById("toggle-sell-low").addEventListener("change", function() {
                renderTimeline();
            });
            document.getElementById("toggle-show-name").addEventListener("change", function() {
                renderTimeline();
            });
            document.getElementById("toggle-show-profit").addEventListener("change", function() {
                renderTimeline();
            });
        });
    </script>
</body>
</html>
