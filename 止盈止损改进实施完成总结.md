# 止盈止损计算改进 - 实施完成总结

## ✅ 已完成的工作

### 1. 数据库结构改造
- ✅ 创建了 `stock_signal_daily_prices` 表，用于存储信号产生后每日的价格数据
- ✅ 添加了必要的索引（signal_id, stock_code, date）提升查询性能
- ✅ 表结构包含：signal_id, stock_code, date, open, high, low, close, days_from_signal

### 2. 爬虫代码改造
- ✅ 修改了 `stock_kline.py` 的 `create_table()` 方法，添加新表创建逻辑
- ✅ 修改了 `update_price_extremes()` 方法，在计算最高价和最低价时，同时保存每日价格数据
- ✅ 新数据会自动保存每日价格，无需额外操作

### 3. 后端API改造
- ✅ 添加了 `/api/signal-daily-prices` 接口
- ✅ 支持通过 `signal_id` 或 `stock_code + insert_date` 查询每日价格数据
- ✅ 修改了 `/api/calendar/events` 接口，添加了 `id` 字段，便于查询每日价格数据

### 4. 前端计算逻辑改造
- ✅ 修改了 `calculateProfitForStock()` 函数，优先使用每日价格数据计算止盈止损
- ✅ 实现了按时间顺序判断止盈/止损触发，准确计算触发天数
- ✅ 向后兼容：没有每日价格数据时，自动使用旧逻辑
- ✅ 添加了 `loadDailyPricesForEvents()` 函数，批量加载每日价格数据
- ✅ 在 `reloadTimeline()` 中自动加载每日价格数据

### 5. 数据补充脚本
- ✅ 创建了 `backfill_daily_prices.py` 脚本，为历史信号补充每日价格数据
- ✅ 实现了K线数据获取功能（使用爬虫的API逻辑）
- ✅ 添加了进度显示、错误处理和批次处理功能
- ✅ 支持命令行参数：股票代码、日期范围、延迟设置等

### 6. 验证脚本
- ✅ 创建了 `verify_daily_prices.py` 脚本，验证数据补充结果
- ✅ 支持统计和详细报告
- ✅ 可以显示缺少价格数据的信号列表

## 📋 使用方法

### 1. 新数据自动保存
新运行的爬虫会自动保存每日价格数据，无需额外操作。

### 2. 补充历史数据

#### 查看需要补充的信号
```bash
python backfill_daily_prices.py --dry-run
```

#### 补充所有历史数据
```bash
python backfill_daily_prices.py
```

#### 补充指定股票的数据
```bash
python backfill_daily_prices.py --stock-codes sh600000 sh600001
```

#### 补充指定日期范围的数据
```bash
python backfill_daily_prices.py --start-date 2026-01-01 --end-date 2026-01-31
```

#### 设置请求延迟（避免API限制）
```bash
python backfill_daily_prices.py --delay 1.0
```

### 3. 验证数据补充结果

#### 基本验证
```bash
python verify_daily_prices.py
```

#### 显示详细信息
```bash
python verify_daily_prices.py --show-details
```

#### 显示缺少价格数据的信号
```bash
python verify_daily_prices.py --show-missing
```

#### 显示数据不完整的信号
```bash
python verify_daily_prices.py --show-incomplete
```

## 🔍 改进效果

### 之前的问题
- ❌ 只比较最高价和最低价的天数，无法准确判断哪个先触发
- ❌ 如果股票先跌到止损价，然后又涨到止盈价，可能误判为先触发止盈
- ❌ 无法准确计算触发时的实际价格

### 现在的改进
- ✅ 按时间顺序遍历每日价格，准确判断哪个先触发
- ✅ 准确计算触发天数
- ✅ 支持更复杂的止盈止损策略（如盘中触发）
- ✅ 为未来扩展提供数据基础（如回测、策略优化）

## 📊 数据说明

### 每日价格数据表结构
- `signal_id`: 关联的信号ID
- `stock_code`: 股票代码
- `date`: 日期（YYYY-MM-DD）
- `open`: 开盘价
- `high`: 最高价
- `low`: 最低价
- `close`: 收盘价
- `days_from_signal`: 距离信号产生的天数（0表示当天）

### 数据量估算
- 每个信号存储30天的数据
- 如果信号很多，数据量会较大
- 建议定期清理旧数据或使用数据归档策略

## ⚠️ 注意事项

1. **API限制**：补充历史数据时，注意API调用频率限制，建议设置适当的延迟
2. **数据一致性**：使用事务确保数据一致性
3. **向后兼容**：没有每日价格数据时，系统会自动使用旧逻辑，不影响现有功能
4. **性能优化**：批量加载每日价格数据，避免N+1查询问题

## 🚀 下一步建议

1. **运行爬虫**：运行一次爬虫，验证新数据是否正确保存每日价格
2. **补充历史数据**：运行 `backfill_daily_prices.py` 为历史信号补充数据
3. **验证结果**：运行 `verify_daily_prices.py` 检查数据完整性
4. **测试前端**：在前端测试止盈止损计算是否准确

## 📝 相关文件

- `Spiders/spiders/stock_kline.py` - 爬虫主文件
- `Spiders/web/app.py` - Web应用后端
- `Spiders/web/static/js/calendar.js` - 前端JavaScript
- `backfill_daily_prices.py` - 数据补充脚本
- `verify_daily_prices.py` - 数据验证脚本

## ✨ 完成状态

所有计划中的任务已完成！系统现在可以准确计算止盈止损了。
